# Hardened Docker Compose Configuration
# Security-focused deployment with enhanced controls

version: '3.8'

services:
  bot:
    build:
      context: .
      dockerfile: Dockerfile.hardened
    container_name: ai_trading_bot_hardened
    restart: unless-stopped

    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

    # Read-only root filesystem
    read_only: true

    # Temporary filesystem for /tmp
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

    # Volumes (only writable directories)
    volumes:
      - ./logs:/app/logs:rw,noexec,nosuid
      - ./models_saved:/app/models_saved:ro
      - ./data:/app/data:rw,noexec,nosuid
      - ./config:/app/config:ro

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Environment variables (use Docker secrets in production)
    environment:
      - TZ=UTC
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - DB_PASSWORD=${DB_PASSWORD}

    # Use secrets instead of env vars (recommended for production)
    # secrets:
    #   - binance_api_key
    #   - binance_api_secret
    #   - telegram_token
    #   - db_password

    # Dependencies
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    # Network
    networks:
      - trading_network

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: timescale/timescaledb:latest-pg14
    container_name: trading_db_hardened
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    environment:
      POSTGRES_DB: trading
      POSTGRES_USER: trader
      POSTGRES_PASSWORD: ${DB_PASSWORD}

    volumes:
      - postgres_data:/var/lib/postgresql/data:rw

    ports:
      - "127.0.0.1:5432:5432"  # Bind to localhost only

    networks:
      - trading_network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trader"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: trading_cache_hardened
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

    # Redis configuration
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1
      --loglevel warning

    ports:
      - "127.0.0.1:6379:6379"  # Bind to localhost only

    networks:
      - trading_network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: trading_dashboard_hardened
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    read_only: true

    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs:ro

    ports:
      - "127.0.0.1:8501:8501"  # Bind to localhost only (use reverse proxy)

    depends_on:
      - postgres

    networks:
      - trading_network

# Docker secrets (production recommendation)
# secrets:
#   binance_api_key:
#     external: true
#   binance_api_secret:
#     external: true
#   telegram_token:
#     external: true
#   db_password:
#     external: true

volumes:
  postgres_data:
    driver: local

networks:
  trading_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
